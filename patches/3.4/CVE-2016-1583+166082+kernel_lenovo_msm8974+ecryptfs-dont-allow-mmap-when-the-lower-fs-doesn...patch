From fa7b3279c8fb3cf8ca7cfaf6fbfc6f8edfe587b9 Mon Sep 17 00:00:00 2001
From: Jeff Mahoney <jeffm@suse.com>
Date: Tue, 05 Jul 2016 21:32:30 +0000
Subject: [PATCH] ecryptfs: don't allow mmap when the lower fs doesn't support it

There are legitimate reasons to disallow mmap on certain files, notably
in sysfs or procfs.  We shouldn't emulate mmap support on file systems
that don't offer support natively.

CVE-2016-1583

Signed-off-by: Jeff Mahoney <jeffm@suse.com>
Cc: stable@vger.kernel.org
[tyhicks: clean up f_op check by using ecryptfs_file_to_lower()]
Signed-off-by: Tyler Hicks <tyhicks@canonical.com>
(adapted from commit f0fe970df3838c202ef6c07a4c2b36838ef0a88b)

Change-Id: I3eb979e9476847834eeea0ecbaf07a53329a7219
---

diff --git a/fs/ecryptfs/file.c b/fs/ecryptfs/file.c
index 2b17f2f..45fa3d8 100644
--- a/fs/ecryptfs/file.c
+++ b/fs/ecryptfs/file.c
@@ -151,6 +151,15 @@
 static int ecryptfs_file_mmap(struct file *file, struct vm_area_struct *vma)
 {
 	int rc;
+	struct file *lower_file = ecryptfs_file_to_lower(file);
+
+	/*
+	 * Don't allow mmap on top of file systems that don't support it
+	 * natively.  If FILESYSTEM_MAX_STACK_DEPTH > 2 or ecryptfs
+	 * allows recursive mounting, this will need to be extended.
+	 */
+	if (!lower_file->f_op->mmap)
+		return -ENODEV;
 
 	rc = generic_file_mmap(file, vma);
 	if (!rc)
