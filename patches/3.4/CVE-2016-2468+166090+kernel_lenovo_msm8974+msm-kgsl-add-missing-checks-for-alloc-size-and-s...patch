From 41f57d27d2df974a5d6ee574155513b69366711d Mon Sep 17 00:00:00 2001
From: Rajesh Kemisetti <rajeshk@codeaurora.org>
Date: Tue, 12 Apr 2016 23:17:10 -0700
Subject: [PATCH] msm: kgsl: Add missing checks for alloc size and sglen

In _kgsl_sharedmem_page_alloc():

- Make len of type size_t to be in line with size.
  - Check for boundary limits of requested alloc size before honoring.
    - Make sure sglen is greater than zero before marking it as end
      of sg list.

BUG=27475454

Change-Id: I8e18aad2118f58ce677050ff4c4a4b0823c4b4b3
---

diff --git a/drivers/gpu/msm/kgsl_sharedmem.c b/drivers/gpu/msm/kgsl_sharedmem.c
index c04c4d0..a316a76 100644
--- a/drivers/gpu/msm/kgsl_sharedmem.c
+++ b/drivers/gpu/msm/kgsl_sharedmem.c
@@ -617,13 +617,18 @@
 			size_t size)
 {
 	int pcount = 0, ret = 0;
-	int j, len, page_size, sglen_alloc, sglen = 0;
+	int j, page_size, sglen_alloc, sglen = 0;
+	size_t len;
 	struct page **pages = NULL;
 	pgprot_t page_prot = pgprot_writecombine(PAGE_KERNEL);
 	void *ptr;
 	unsigned int align;
 	int step = ((VMALLOC_END - VMALLOC_START)/8) >> PAGE_SHIFT;
 
+	size = PAGE_ALIGN(size);
+	if (size == 0 || size > UINT_MAX)
+		return -EINVAL;
+
 	align = (memdesc->flags & KGSL_MEMALIGN_MASK) >> KGSL_MEMALIGN_SHIFT;
 
 	page_size = (align >= ilog2(SZ_64K) && size >= SZ_64K)
