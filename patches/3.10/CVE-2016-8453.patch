From 15a311f8810581867d31022ec6b2a2ba343302a2 Mon Sep 17 00:00:00 2001
From: Mekala Natarajan <mekalan@codeaurora.org>
Date: Tue, 13 Oct 2015 11:17:30 -0700
Subject: [PATCH] ASoC: msm-cpe-lsm: move slimbus channel open to LAB thread

Opening Slimbus channels before starting the lab thread can
lead to issues, when CPE LAB thread stop is called after opening
Slimbus master/slave ports, but before scheduling LAB thread.
In this case, error will be returned when trying to stop the
LAB thread and if not closed cleanly, Slimbus channel open for
next CPE session will fail. This will result in failure for all
subsequent CPE LAB sessions.
Move Slimbus channel open inside LAB thread so that the channels
are opened only after creating and scheduling the LAB thread.

Bug: 24774316
Bug: 24872437
Change-Id: I014fe6aed34dcaa896e1aa7a45a898485e783dd8
Signed-off-by: Banajit Goswami <bgoswami@codeaurora.org>
Signed-off-by: Mekala Natarajan <mekalan@codeaurora.org>
---
 sound/soc/msm/msm-cpe-lsm.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/sound/soc/msm/msm-cpe-lsm.c b/sound/soc/msm/msm-cpe-lsm.c
index 8cc10f7bc8283..8673f80207061 100644
--- a/sound/soc/msm/msm-cpe-lsm.c
+++ b/sound/soc/msm/msm-cpe-lsm.c
@@ -396,6 +396,8 @@ static int msm_cpe_lab_thread(void *data)
 	}
 
 	if (!kthread_should_stop()) {
+		lsm_ops->lsm_lab_data_channel_open(cpe->core_handle, session);
+
 		rc = lsm_ops->lsm_lab_data_channel_read(core, lab->lsm_s,
 					lab->pcm_buf[0].phys,
 					lab->pcm_buf[0].mem,
@@ -1320,8 +1322,6 @@ static int msm_cpe_lsm_lab_start(struct snd_pcm_substream *substream,
 		atomic_set(&lab_sess->abort_read, 0);
 		pr_debug("%s: KW detected,\n"
 		"scheduling LAB thread\n", __func__);
-		lsm_ops->lsm_lab_data_channel_open(
-			cpe->core_handle, session);
 
 		/*
 		 * Even though thread might be only scheduled and